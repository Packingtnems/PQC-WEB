<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8">
  <title>K·∫æT QU·∫¢ KI·ªÇM TRA PQC</title>
  <style>
    /* Common styles */
    body { font-family: Arial, sans-serif; margin: 0; padding: 0; background: #f5f7fa; }
    .container { padding: 20px; }
    .tab-buttons { display: flex; gap: 10px; margin-bottom: 15px; }
    .tab-buttons button {
      padding: 10px 20px; border: none; border-radius: 6px;
      background: #34495e; color: #fff; cursor: pointer;
    }
    .tab-buttons button.active { background: #27ae60; }
    .tab-content { display: none; }
    .tab-content.active { display: block; }
    
    /* Tab 1: Ph√°n ƒë·ªãnh s·∫£n ph·∫©m */
    .app-container { display: flex; flex-direction: row; }
    .left, .right { padding: 20px; overflow-y: auto; }
    .left { width: 40%; border-right: 2px solid #ccc; position: relative; }
    .right { width: 60%; }
    label { font-weight: bold; display: block; margin: 10px 0 5px; }
    input, select { padding: 5px; width: 200px; margin-bottom: 10px; }
    button { padding: 8px 16px; margin: 6px; border-radius: 6px; border: 1px solid #333; font-size: 14px; cursor: pointer; }
    #okBtn { color: green; }
    #ngBtn { color: red; }
    #error { color: red; font-weight: bold; margin-top: 10px; }
    table { margin-top: 10px; border-collapse: collapse; width: 100%; }
    th, td { border: 1px solid #ccc; padding: 6px; text-align: center; }
    th { background: #eee; }
    .duplicate { background-color: #ffb3b3; }
    #loginScreen { margin-top: 50px; text-align: center; }
    .mainApp { display: none; }
    #clearLogBtn, #resetDataBtn { position: absolute; top: 12px; padding: 6px 12px; border: none; border-radius: 6px; cursor: pointer; }
    #clearLogBtn { right: 120px; background: #3498db; color: white; }
    #clearLogBtn:hover { background: #2980b9; }
    #resetDataBtn { right: 12px; background: #e74c3c; color: white; }
    #resetDataBtn:hover { background: #c0392b; }
    .stat { margin-top: 8px; font-size: 14px; }
    
    /* Tab 2: L·ªçc d·ªØ li·ªáu */
    .filter-container { display: flex; flex-wrap: wrap; gap: 15px; margin-bottom: 20px; }
    .filter-item { display: flex; flex-direction: column; }
    .filter-item label { font-size: 13px; color: #555; margin-bottom: 4px; }
    .filter-item input, .filter-item select {
      padding: 8px 10px; border-radius: 6px; border: 1px solid #ccc; min-width: 150px; background: #fff;
    }
    .button-container { display: flex; gap: 10px; margin-bottom: 20px; }
    .btn-filter {
      background: #34495e; color: #fff; padding: 10px 20px; border: none; border-radius: 6px; font-size: 14px; cursor: pointer;
    }
    .btn-filter:hover { background: #2c3e50; }
    .btn-download {
      background: #27ae60; color: #fff; padding: 10px 20px; border: none; border-radius: 6px; font-size: 14px; cursor: pointer;
    }
    .btn-download:hover { background: #1e874b; }
    
    /* Tab 3: Bi·ªÉu ƒë·ªì */
    .chart-container { margin-bottom: 30px; }
    .chart-container h3 { margin-bottom: 10px; }
    canvas { max-width: 100%; background: white; border: 1px solid #ddd; border-radius: 4px; padding: 10px; }
    
    /* Th√™m style cho th√¥ng b√°o */
    .sync-status {
      padding: 10px;
      margin: 10px 0;
      border-radius: 4px;
      display: none;
    }
    .sync-success {
      background-color: #d4edda;
      color: #155724;
      border: 1px solid #c3e6cb;
    }
    .sync-error {
      background-color: #f8d7da;
      color: #721c24;
      border: 1px solid #f5c6cb;
    }
    
    /* Style cho ph·∫ßn s·ªë l∆∞·ª£ng giao v√† s·ªë l∆∞·ª£ng NG */
    .delivery-section {
      display: flex;
      gap: 15px;
      margin-bottom: 15px;
    }
    .delivery-item {
      display: flex;
      flex-direction: column;
    }
    .delivery-item label {
      font-size: 14px;
      margin-bottom: 5px;
    }
    .delivery-item input {
      width: 120px;
    }
    
    /* Style cho th√¥ng b√°o ƒë·ªô d√†i QR code */
    #qrcodeLengthInfo {
      font-size: 12px;
      margin-top: -5px;
      margin-bottom: 10px;
      padding: 3px 8px;
      border-radius: 4px;
      display: inline-block;
    }
    .valid-length {
      background-color: #d4edda;
      color: #155724;
      border: 1px solid #c3e6cb;
    }
    .invalid-length {
      background-color: #f8d7da;
      color: #721c24;
      border: 1px solid #f5c6cb;
    }
    .info-length {
      background-color: #d1ecf1;
      color: #0c5460;
      border: 1px solid #bee5eb;
    }
  </style>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/clusterize.js@0.18.1/clusterize.min.js"></script>
</head>
<body>
     <div style="margin-top:20px; display:flex; gap:10px; ">
      <img src="logo.png" alt="Logo" style="height: 100px; width: auto; margin-right: 20px;">
      <h2>üìä K·∫æT QU·∫¢ KI·ªÇM TRA PQC</h2>
      </div>

    <div class="tab-buttons">
      <button id="btnTab1" class="active" onclick="showTab(1)">üìù Ph√°n ƒë·ªãnh s·∫£n ph·∫©m</button>
      <button id="btnTab2" onclick="showTab(2)">üìë D·ªØ li·ªáu</button>
      <button id="btnTab3" onclick="showTab(3)">üìà Bi·ªÉu ƒë·ªì</button>
    </div>
    
    <!-- Tab 1: Ph√°n ƒë·ªãnh s·∫£n ph·∫©m -->
    <div id="tab1" class="tab-content active">
      <!-- M√†n h√¨nh ƒëƒÉng nh·∫≠p -->
      <div id="loginScreen">
        <h2>ƒêƒÉng nh·∫≠p</h2>
        <label for="loginUser">T√™n ƒëƒÉng nh·∫≠p</label>
        <input type="text" id="loginUser" placeholder="Nh·∫≠p m√£ s·ªë nh√¢n vi√™n">

        <label for="loginPass">M·∫≠t kh·∫©u</label>
        <input type="password" id="loginPass" placeholder="Nh·∫≠p m·∫≠t kh·∫©u">

        <label for="shift">Ch·ªçn ca</label>
        <select id="shift">
          <option value="Ca 1 (06:00-14:00)">Ca 1 (06:00 - 14:00)</option>
          <option value="Ca 2 (14:00-22:00)">Ca 2 (14:00 - 22:00)</option>
          <option value="Ca 1 d√†i (06:00-18:00)">Ca 1 d√†i (06:00 - 18:00)</option>
          <option value="Ca 2 d√†i (18:00-06:00)">Ca 2 d√†i (18:00 - 06:00 h√¥m sau)</option>
          <option value="Ca HC (08:00-16:30)">Ca HC (08:00 - 16:30)</option>
        </select>

        <label for="wo">S·ªë l·ªánh s·∫£n xu·∫•t (WO)</label>
        <input type="text" id="wo" placeholder="Nh·∫≠p s·ªë WO" oninput="this.value=this.value.toUpperCase()">

        <br>
        <button onclick="login()">ƒêƒÉng nh·∫≠p</button>
        <p id="loginError" style="color:red;"></p>
      </div>

      <!-- Giao di·ªán ch√≠nh -->
      <div id="mainApp" class="mainApp app-container">
        <!-- C·ªôt tr√°i -->
        <div class="left">
          <h2>Ph√°n ƒë·ªãnh s·∫£n ph·∫©m</h2>
          <button id="clearLogBtn" onclick="clearLogDisplay()">X√≥a log</button>
          <button id="resetDataBtn" onclick="resetAllData()">Reset d·ªØ li·ªáu</button>

          <p class="stat">üë§ Ng∆∞·ªùi ki·ªÉm tra: <b id="currentUser"></b></p>
          <p class="stat">üïí Ca: <b id="currentShift"></b></p>
          <p class="stat">üìã WO: <b id="currentWO"></b></p>
          <p class="stat">‚úÖ OK: <b id="okCount">0</b> | ‚ùå NG: <b id="ngCount">0</b></p>

          <!-- Ph·∫ßn s·ªë l∆∞·ª£ng giao v√† s·ªë l∆∞·ª£ng NG -->
          <div class="delivery-section">
            <div class="delivery-item">
              <label for="deliveryQty"><b>S·ªê L∆Ø·ª¢NG GIAO</b></label>
              <input type="number" id="deliveryQty" value="0" min="0" style="width:120px;">
            </div>
            <div class="delivery-item">
              <label for="ngQty"><b>S·ªê L∆Ø·ª¢NG NG</b></label>
              <input type="number" id="ngQty" value="0" min="0" style="width:120px;">
            </div>
          </div>
          <p id="deliveryStatus" style="color:blue;font-weight:bold;"></p>
          <p id="ngStatus" style="color:red;font-weight:bold;"></p>

          <label for="mahang">M√£ h√†ng</label>
          <select id="mahang" onchange="updateQRCodeInfo()">
          <option value="">-- Ch·ªçn m√£ h√†ng --</option>
            <option value="ECM-2583-236">ECM-2583-236</option>
            <option value="ECM-2583-164">ECM-2583-164</option>
            <option value="ECM-2300">ECM-2300</option>
            <option value="ECM-2310">ECM-2310</option>
            <option value="IZ-1-R3">IZ-1-R3</option>
            <option value="RM-4K-R3">RM-4K-R3</option>
            <option value="AM-4-R3">AM-4-R3</option>
            <option value="P-7937">P-7937</option>
            <option value="P-8105">P-8105</option>
            <option value="P-8149">P-8149</option>
            <option value="BMS 85AH">BMS 85AH</option>
            <option value="BMS 57AH">BMS 57AH</option>
            <option value="CONTROLLER">CONTROLLER</option>
            <option value="CAS NEMO">CAS NEMO</option>
            <option value="CAS MINI-DI">CAS MINI-DI</option>
            <option value="CAS MINI-485">CAS MINI-485</option>
            <option value="BN 2573A">BN 2573A</option>
            <option value="OEM">OEM</option>
          </select>
          
          <!-- Th√¥ng b√°o ƒë·ªô d√†i QR code -->
          <div id="qrcodeLengthInfo" class="info-length"></div>
          
          <label for="qrcode">QR Code</label>
          <input type="text" id="qrcode" placeholder="Qu√©t QR code" oninput="updateQRCodeInfo(); this.value=this.value.toUpperCase()">

          <label for="loi">L·ªói / Ghi ch√∫</label>
          <div style="display: flex; gap: 10px;">
            <input list="errorList" id="loi" placeholder="Nh·∫≠p l·ªói (n·∫øu c√≥)">
            <input type="text" id="ghichu" placeholder="Nh·∫≠p ghi ch√∫ (n·∫øu c√≥)">
          </div>
          <datalist id="errorList">
            <option value="Thanh ƒë·ªìng sai k√≠ch th∆∞·ªõc">Thanh ƒë·ªìng sai k√≠ch th∆∞·ªõc</option>
            <option value="M·∫•t linh ki·ªán">M·∫•t linh ki·ªán</option>
            <option value="B·∫Øc c·∫ßu">B·∫Øc c·∫ßu</option>
            <option value="L·ªói Connector tr·∫Øng">Connector tr·∫Øng</option>
            <option value="Ng∆∞·ª£c h∆∞·ªõng">Ng∆∞·ª£c h∆∞·ªõng</option>
            <option value="L·ªói D√¢y √¢m">D√¢y √¢m</option>
            <option value="L·ªói M·ªëi h√†n">M·ªëi h√†n</option>
            <option value="L·ªói B·ªçc co nhi·ªát">B·ªçc co nhi·ªát</option>
            <option value="L·ªói Connector ƒëen">Connector ƒëen</option>
            <option value="H∆∞ linh ki·ªán">H∆∞ linh ki·ªán</option>
            <option value="L·ªói PCB">PCB</option>
            <option value="L·ªói QR">QR</option>
            <option value="L·ªói V·ªá sinh">V·ªá sinh</option>
            <option value="L·ªói Test ƒëi·ªán">Test ƒëi·ªán</option>
            <option value="L·ªói thi·∫øu nahx Test pass">Test pass</option>
            <option value="L·ªói Coating">Coating</option>
          </datalist>

          <div>
            <button id="okBtn" onclick="saveData('OK')">OK</button>
            <button id="ngBtn" onclick="saveData('NG')">NG</button>
          </div>
        
          <p id="error"></p>

          <!-- Th√™m th√¥ng b√°o tr·∫°ng th√°i ƒë·ªìng b·ªô -->
          <div id="syncStatus" class="sync-status"></div>

          <div>
            <button onclick="exportCSV()">Xu·∫•t logfile</button>
            <button onclick="syncToSheet(true)">ƒê·ªìng b·ªô Google Sheets</button>
            <button onclick="endShiftReport()">B√°o c√°o cu·ªëi ca</button>
          </div>

          <!-- Bi·ªÉu ƒë·ªì realtime -->
          <div>
            <h3>B√°o c√°o real-time</h3>
            <div style="width: 200px; height: 200px;">
              <canvas id="chartOKNG"></canvas>
            </div>
          </div>
        </div>

        <!-- C·ªôt ph·∫£i -->
        <div class="right">
          <!-- B·ªô l·ªçc -->
          <div>
            <input type="text" id="searchBox" placeholder="T√¨m QR / M√£ h√†ng" onkeyup="renderTable()">
            <select id="filterResult" onchange="renderTable()">
              <option value="">--T·∫•t c·∫£--</option>
              <option value="OK">OK</option>
              <option value="NG">NG</option>
            </select>
          </div>
          <table id="logTable">
            <thead>
              <tr>
                <th>M√£ h√†ng</th>
                <th>QR Code</th>
                <th>Ph√¢n ƒë·ªãnh</th>
                <th>M√¥ t·∫£ l·ªói</th>
                <th>Ng√†y</th>
                <th>Gi·ªù</th>
                <th>S·ªë l·∫ßn xu·∫•t hi·ªán</th>
                <th>M√£ nh√¢n vi√™n</th>
                <th>Shift</th>
                <th>WO</th>
                <th>Ghi ch√∫</th>
                <th>S·ªë l∆∞·ª£ng giao</th>
                <th>S·ªë l∆∞·ª£ng NG</th>
                <th>Thao t√°c</th>
              </tr>
            </thead>
            <tbody></tbody>
          </table>
        </div>
      </div>
    </div>
    
    <!-- Tab 2: D·ªØ li·ªáu -->
    <div id="tab2" class="tab-content">
      <div class="filter-container">
        <div class="filter-item">
          <label for="fromDate">T·ª´ ng√†y</label>
          <input type="date" id="fromDate">
        </div>
        <div class="filter-item">
          <label for="toDate">ƒê·∫øn ng√†y</label>
          <input type="date" id="toDate">
        </div>
        <div class="filter-item">
          <label for="maSP">M√£ s·∫£n ph·∫©m</label>
          <select id="maSP"><option value="">T·∫•t c·∫£ m√£</option></select>
        </div>
        <div class="filter-item">
          <label for="searchQR">T√¨m QR Code</label>
          <input type="text" id="searchQR" placeholder="Nh·∫≠p QR Code ƒë·ªÉ l·ªçc..." oninput="applyFilters()">
        </div>
        <div class="filter-item">
          <label for="po">WO</label>
          <select id="po"><option value="">T·∫•t c·∫£ WO</option></select>
        </div>
      </div>

      <div class="button-container">
        <button class="btn-filter" onclick="applyFilters()">L·ªçc d·ªØ li·ªáu</button>
        <button class="btn-download" onclick="reloadFromGoogle()">‚≠Æ T·∫£i t·ª´ Google Sheets</button>
      </div>

      <div id="scrollArea" style="height:500px; overflow:auto; border:1px solid #ccc;">
        <table id="reportTable" style="width:100%; border-collapse:collapse;">
          <thead>
            <tr>
              <th>M√£ H√†ng</th>
              <th>QR Code</th>
              <th>Ph√°n ƒë·ªãnh</th>
              <th>M√¥ t·∫£ l·ªói</th>
              <th>Gi·ªù</th>
              <th>Ng√†y</th>
              <th>S·ªë l·∫ßn xu·∫•t hi·ªán</th>
              <th>M√£ nh√¢n vi√™n</th>
              <th>Ca</th>
              <th>WO</th>
              <th>Ghi ch√∫</th>
              <th>S·ªë l∆∞·ª£ng giao</th>
              <th>S·ªë l∆∞·ª£ng NG</th>
            </tr>
          </thead>
          <tbody id="clusterize-content" class="clusterize-content"></tbody>
        </table>

        <!-- ‚úÖ B·∫Øt bu·ªôc ph·∫£i n·∫±m TRONG scrollArea, ngay d∆∞·ªõi b·∫£ng -->
        <div id="clusterize-scroll" class="clusterize-scroll"></div>
      </div>

      <!-- D√≤ng n√†y n·∫±m ngo√†i ƒë·ªÉ hi·ªÉn th·ªã t·ªïng s·ªë d√≤ng -->
      <div id="recordCount" style="margin-top:5px; font-weight:bold;"></div>
    </div>
      
    <!-- Tab 3: Bi·ªÉu ƒë·ªì -->
    <div id="tab3" class="tab-content">
      <div class="chart-container">
        <h3>üìä Bi·ªÉu ƒë·ªì Pareto (theo M√¥ t·∫£ l·ªói)</h3>
        <div style="height: 400px;">
          <canvas id="paretoChart"></canvas>
        </div>
      </div>
      
      <div class="chart-container">
        <h3>üìà Bi·ªÉu ƒë·ªì so s√°nh theo ng√†y</h3>
        <div style="height: 400px;">
          <canvas id="dailyChart"></canvas>
        </div>
      </div>
    </div>
  </div>

  <script>
    // ===== H√ÄM QU·∫¢N L√ù TAB =====
    function showTab(n) {
      document.querySelectorAll('.tab-buttons button').forEach(b => b.classList.remove('active'));
      document.querySelectorAll('.tab-content').forEach(t => t.classList.remove('active'));
      document.getElementById('btnTab' + n).classList.add('active');
      document.getElementById('tab' + n).classList.add('active');
      
      // üî• TH√äM: Khi chuy·ªÉn sang tab 3, v·∫Ω bi·ªÉu ƒë·ªì v·ªõi d·ªØ li·ªáu hi·ªán t·∫°i
      if (n === 3) {
        setTimeout(() => {
          const dataToUse = filteredDataGlobal.length > 0 ? filteredDataGlobal : allData;
          drawPareto(dataToUse);
          drawDailyChart(dataToUse);
        }, 100);
      }
      
      // ‚úÖ Ch·ªâ t·∫£i l·∫°i t·ª´ Google khi ng∆∞·ªùi d√πng th·∫≠t s·ª± b·∫•m n√∫t "T·∫£i t·ª´ Google Sheets"
      if (n === 2 && !window.preventAutoReload) {
        reloadFromGoogle();
      }
    }

    // ===== PH·∫¶N PH√ÅN ƒê·ªäNH S·∫¢N PH·∫®M =====
    /* ===== Data & users ===== */
    const users = {
      "5035": "123456",
      "3062": "223456", // HI·∫æU
      "5053": "334567", // LY
      "5088": "445678", // QU·ª≤NH
      "5383": "556789", // VY
      "5381": "667890", // OANH
      "5623": "778901", // PH√ÅT 
      "5718": "889012", // NGA
      "5628": "990123", // TH√ÄNH
      "5720": "112345", // M·ª∏
      "5264": "001234", // KH√ÅNH
      "4810": "1903", // C.TRANG
    };
    
    // Quy ƒë·ªãnh s·ªë k√Ω t·ª± t·ªëi thi·ªÉu v√† t·ªëi ƒëa cho t·ª´ng m√£ h√†ng
    const lengthRulesByProduct = {
      "ECM-2583-236": { min: 15, max: 20 },
      "ECM-2583-164": { min: 15, max: 20 },
      "ECM-2300": { min: 10, max: 15 },
      "ECM-2310": { min: 10, max: 15 },
      "IZ-1-R3": { min: 46, max: 48 },
      "RM-4K-R3": { min: 46, max: 48 },
      "AM-4-R3": { min: 46, max: 48 },
      "P-7937": { min: 8, max: 10 },
      "P-8105": { min: 8, max: 10 },
      "P-8149": { min: 8, max: 10 },
      "BMS 85AH": { min: 22, max: 27 },
      "BMS 57AH": { min: 22, max: 27 },
      "CONTROLLER": { min: 22, max: 27 },
      "CAS NEMO": { min: 10, max: 12 },
      "CAS MINI-DI": { min: 12, max: 15 },
      "CAS MINI-485": { min: 12, max: 15 },
      "BN 2573A": { min: 10, max: 12 },
      "OEM": { min: 8, max: 10 }
    };
    
    // records[0] l√† header - ƒê√É TH√äM C·ªòT "S·ªë l∆∞·ª£ng giao" v√† "S·ªë l∆∞·ª£ng NG"
    let records = [["M√£ h√†ng","QR Code","K·∫øt qu·∫£","L·ªói","Gi·ªù","Ng√†y","S·ªë l·∫ßn xu·∫•t hi·ªán","Ng∆∞·ªùi ki·ªÉm tra","Ca","WO","Ghi ch√∫","S·ªë l∆∞·ª£ng giao","S·ªë l∆∞·ª£ng NG","Synced"]];
    let qrCounter = {};
    let currentUser = "";
    let currentShift = "";
    let currentWO = "";
    let okCount = 0, ngCount = 0;
    let chart;

    let deliveryTarget = 0;    // s·ªë l∆∞·ª£ng giao c·∫ßn ƒë·∫°t
    let deliveryCounter = 0;   // s·ªë QR code ƒë√£ qu√©t trong ƒë·ª£t
    let ngTarget = 0;          // s·ªë l∆∞·ª£ng NG c·∫ßn ƒë·∫°t
    let ngCounter = 0;         // s·ªë QR code NG ƒë√£ qu√©t trong ƒë·ª£t

    // Load t·ª´ localStorage
    if (localStorage.getItem("records")) {
      try { 
        const savedRecords = JSON.parse(localStorage.getItem("records"));
        if (Array.isArray(savedRecords) && savedRecords.length > 0) {
          records = savedRecords;
        }
      } catch(e) { 
        console.error("L·ªói khi load records t·ª´ localStorage:", e);
      }
    }
    
    if (localStorage.getItem("qrCounter")) {
      try { 
        qrCounter = JSON.parse(localStorage.getItem("qrCounter")); 
      } catch(e) { 
        console.error("L·ªói khi load qrCounter t·ª´ localStorage:", e);
      }
    }

    /* ===== Utility ===== */
    function findLastRecordIndex(qrcode) {
      for (let i = records.length - 1; i >= 1; i--) {
        if (records[i][1] === qrcode) return i;
      }
      return -1;
    }

    /* ===== C·∫≠p nh·∫≠t th√¥ng tin ƒë·ªô d√†i QR code ===== */
    function updateQRCodeInfo() {
      const mahang = document.getElementById("mahang").value;
      const qrcode = document.getElementById("qrcode").value;
      const infoElement = document.getElementById("qrcodeLengthInfo");
      
      if (!mahang || !lengthRulesByProduct[mahang]) {
        infoElement.textContent = "";
        infoElement.className = "";
        return;
      }
      
      const rules = lengthRulesByProduct[mahang];
      const qrLength = qrcode.length;
      
      if (qrLength === 0) {
        infoElement.textContent = `QR Code ph·∫£i t·ª´ ${rules.min} ƒë·∫øn ${rules.max} k√Ω t·ª±`;
        infoElement.className = "info-length";
      } else if (qrLength < rules.min) {
        infoElement.textContent = `QR Code qu√° ng·∫Øn: ${qrLength}/${rules.min} k√Ω t·ª± (thi·∫øu ${rules.min - qrLength} k√Ω t·ª±)`;
        infoElement.className = "invalid-length";
      } else if (qrLength > rules.max) {
        infoElement.textContent = `QR Code qu√° d√†i: ${qrLength}/${rules.max} k√Ω t·ª± (v∆∞·ª£t ${qrLength - rules.max} k√Ω t·ª±)`;
        infoElement.className = "invalid-length";
      } else {
        infoElement.textContent = `QR Code h·ª£p l·ªá: ${qrLength} k√Ω t·ª± (${rules.min}-${rules.max})`;
        infoElement.className = "valid-length";
      }
    }
    
    function recomputeCountsForShift(shift) {
      let ok = 0, ng = 0;
      
      // L·∫•y k·∫øt qu·∫£ m·ªõi nh·∫•t cho m·ªói QR code
      const latestResults = {};
      
      for (let i = 1; i < records.length; i++) {
        const row = records[i];
        if (row[8] === shift) {
          const qrcode = row[1];
          // Ch·ªâ l·∫•y k·∫øt qu·∫£ m·ªõi nh·∫•t cho m·ªói QR code
          if (!latestResults[qrcode] || i > latestResults[qrcode].index) {
            latestResults[qrcode] = {
              result: row[2],
              index: i
            };
          }
        }
      }
      
      // ƒê·∫øm counts t·ª´ k·∫øt qu·∫£ m·ªõi nh·∫•t
      for (const qrcode in latestResults) {
        if (latestResults[qrcode].result === "OK") ok++;
        else if (latestResults[qrcode].result === "NG") ng++;
      }
      
      okCount = ok; 
      ngCount = ng;
      document.getElementById("okCount").textContent = okCount;
      document.getElementById("ngCount").textContent = ngCount;
      updateChart();
    }

    /* ===== Login ===== */
    function login() {
      const uRaw = document.getElementById("loginUser").value.trim();
      const p = document.getElementById("loginPass").value.trim();
      const s = document.getElementById("shift").value;
      const wo = document.getElementById("wo").value.trim();
      
      if (!uRaw || !wo) { 
        document.getElementById("loginError").textContent = "‚ö†Ô∏è Vui l√≤ng nh·∫≠p ƒë·∫ßy ƒë·ªß!"; 
        return; 
      }
      
      const u = uRaw.toUpperCase();
      if (users[u] && users[u] === p) {
        currentUser = u;
        currentShift = s;
        currentWO = wo;
        document.getElementById("currentUser").textContent = currentUser;
        document.getElementById("currentShift").textContent = currentShift;
        document.getElementById("currentWO").textContent = currentWO;
        document.getElementById("loginScreen").style.display = "none";
        document.getElementById("mainApp").style.display = "flex";
        recomputeCountsForShift(currentShift);
        renderTable();
      } else {
        document.getElementById("loginError").textContent = "‚ö†Ô∏è Sai t√™n ƒëƒÉng nh·∫≠p ho·∫∑c m·∫≠t kh·∫©u!";
      }
    }

    /* ===== Save / Update log ===== */
    function saveData(result) {
      // üîπ KI·ªÇM TRA ƒêI·ªÄU KI·ªÜN: S·ªë l∆∞·ª£ng giao ph·∫£i > 0
      if (deliveryTarget <= 0) {
        alert("‚ö†Ô∏è Vui l√≤ng nh·∫≠p S·ªê L∆Ø·ª¢NG GIAO (l·ªõn h∆°n 0) tr∆∞·ªõc khi qu√©t!");
        document.getElementById("deliveryQty").focus();
        document.getElementById("deliveryQty").select();
        return;
      }

      // üîπ KI·ªÇM TRA ƒêI·ªÄU KI·ªÜN: N·∫øu l√† NG th√¨ s·ªë l∆∞·ª£ng NG ph·∫£i > 0
      if (result === "NG" && ngTarget <= 0) {
        alert("‚ö†Ô∏è Vui l√≤ng nh·∫≠p S·ªê L∆Ø·ª¢NG NG (l·ªõn h∆°n 0) tr∆∞·ªõc khi qu√©t NG!");
        document.getElementById("ngQty").focus();
        document.getElementById("ngQty").select();
        return;
      }

      // üîπ Ki·ªÉm tra s·ªë l∆∞·ª£ng giao ƒë√£ ƒë·ªß ch∆∞a
      if (deliveryCounter >= deliveryTarget) {
        alert("‚ö†Ô∏è ƒê√£ ƒë·ªß s·ªë l∆∞·ª£ng giao, kh√¥ng th·ªÉ qu√©t th√™m!");
        return;
      }

      const mahang = document.getElementById("mahang").value.trim().toUpperCase();
      const qrcode = document.getElementById("qrcode").value.trim().toUpperCase();
      const loi = document.getElementById("loi").value.trim();
      const ghichu = document.getElementById("ghichu").value.trim();

      if (!mahang || !qrcode) {
        document.getElementById("error").textContent = "‚ö†Ô∏è Vui l√≤ng nh·∫≠p M√£ h√†ng v√† QR Code!";
        return;
      }
      
      // üîπ KI·ªÇM TRA S·ªê K√ù T·ª∞ THEO M√É H√ÄNG (C·∫¢ MIN V√Ä MAX)
      const rules = lengthRulesByProduct[mahang];
      if (rules) {
        const qrLength = qrcode.length;
        
        if (qrLength < rules.min) {
          alert(`‚ö†Ô∏è QR Code cho m√£ h√†ng ${mahang} ph·∫£i c√≥ √≠t nh·∫•t ${rules.min} k√Ω t·ª±!\nHi·ªán t·∫°i: ${qrLength} k√Ω t·ª± (thi·∫øu ${rules.min - qrLength} k√Ω t·ª±)`);
          document.getElementById("qrcode").value = "";
          document.getElementById("qrcode").focus();
          return;
        }
        
        if (qrLength > rules.max) {
          alert(`‚ö†Ô∏è QR Code cho m√£ h√†ng ${mahang} kh√¥ng ƒë∆∞·ª£c v∆∞·ª£t qu√° ${rules.max} k√Ω t·ª±!\nHi·ªán t·∫°i: ${qrLength} k√Ω t·ª± (v∆∞·ª£t ${qrLength - rules.max} k√Ω t·ª±)`);
          document.getElementById("qrcode").value = "";
          document.getElementById("qrcode").focus();
          return;
        }
      }
      
      document.getElementById("error").textContent = "";

      qrCounter[qrcode] = (qrCounter[qrcode] || 0) + 1;
      
      // üîπ S·ª¨ D·ª§NG L·∫†I C√ÅCH HI·ªÇN TH·ªä TH·ªúI GIAN T·ª™ CODE C≈® - HI·ªÇN TH·ªä ƒê√öNG GI·ªú
      const now = new Date();
      const gio = now.toLocaleTimeString("vi-VN");
      const ngay = now.toLocaleDateString("vi-VN");

      // üîπ THAY ƒê·ªîI: Lu√¥n th√™m b·∫£n ghi m·ªõi, kh√¥ng x√≥a b·∫£n ghi c≈©
      // T√¨m t·∫•t c·∫£ b·∫£n ghi c≈© ƒë·ªÉ c·∫≠p nh·∫≠t counts
      let oldOkCount = 0, oldNgCount = 0;
      for (let i = 1; i < records.length; i++) {
        if (records[i][1] === qrcode) {
          if (records[i][2] === "OK") oldOkCount++;
          else if (records[i][2] === "NG") oldNgCount++;
        }
      }

      // C·∫≠p nh·∫≠t counts (tr·ª´ ƒëi counts c≈©, c·ªông th√™m counts m·ªõi)
      okCount = okCount - oldOkCount;
      ngCount = ngCount - oldNgCount;
      
      if (result === "OK") okCount++;
      else ngCount++;

      // üîπ X√°c ƒë·ªãnh s·ªë l∆∞·ª£ng NG hi·ªÉn th·ªã (ch·ªâ hi·ªÉn th·ªã cho QR code NG ƒë·∫ßu ti√™n)
      let soLuongNGHienThi = 0;
      if (result === "NG" && ngTarget > 0) {
        ngCounter++;
        if (ngCounter === 1) {
          // QR code NG ƒë·∫ßu ti√™n hi·ªÉn th·ªã s·ªë l∆∞·ª£ng NG
          soLuongNGHienThi = ngTarget;
        }
        // C√°c QR code NG ti·∫øp theo kh√¥ng hi·ªÉn th·ªã s·ªë
      }

      // üîπ THAY ƒê·ªîI: Lu√¥n th√™m b·∫£n ghi m·ªõi (kh√¥ng x√≥a b·∫£n ghi c≈©)
      records.push([
        mahang,
        qrcode,
        result,
        loi,
        gio,        // üîπ S·ª¨ D·ª§NG GI·ªú ƒê√öNG T·ª™ CODE C≈®
        ngay,       // üîπ S·ª¨ D·ª§NG NG√ÄY ƒê√öNG T·ª™ CODE C≈®
        qrCounter[qrcode],
        currentUser,
        currentShift,
        currentWO,
        ghichu,
        deliveryTarget, // üîπ TH√äM: S·ªë l∆∞·ª£ng giao
        soLuongNGHienThi, // üîπ TH√äM: S·ªë l∆∞·ª£ng NG (ch·ªâ hi·ªÉn th·ªã cho QR ƒë·∫ßu ti√™n)
        false // üîπ ch∆∞a ƒë·ªìng b·ªô
      ]);

      saveLocal();
      renderTable();
      document.getElementById("okCount").textContent = okCount;
      document.getElementById("ngCount").textContent = ngCount;
      updateChart();

      document.getElementById("qrcode").value = "";
      document.getElementById("loi").value = "";
      document.getElementById("ghichu").value = "";
      
      deliveryCounter++;
      document.getElementById("deliveryStatus").textContent = `ƒê√£ qu√©t ${deliveryCounter}/${deliveryTarget}`;

      // üîπ C·∫≠p nh·∫≠t tr·∫°ng th√°i NG
      if (result === "NG") {
        document.getElementById("ngStatus").textContent = `ƒê√£ qu√©t NG: ${ngCounter}/${ngTarget}`;
      }

      // üîπ Ki·ªÉm tra n·∫øu ƒë√£ ƒë·ªß s·ªë l∆∞·ª£ng NG
      if (ngCounter >= ngTarget && ngTarget > 0) {
        ngTarget = 0;
        ngCounter = 0;
        document.getElementById("ngQty").value = 0;
        document.getElementById("ngStatus").textContent = "";
      }

      if (deliveryCounter >= deliveryTarget) {
        alert(`‚úÖ ƒê√£ ƒë·ªß ${deliveryTarget} s·∫£n ph·∫©m!`);
        document.getElementById("deliveryQty").value = 0;
        deliveryTarget = 0;
        deliveryCounter = 0;
        document.getElementById("deliveryStatus").textContent = "";
        
        // üîπ Reset c·∫£ s·ªë l∆∞·ª£ng NG khi k·∫øt th√∫c ƒë·ª£t giao
        ngTarget = 0;
        ngCounter = 0;
        document.getElementById("ngQty").value = 0;
        document.getElementById("ngStatus").textContent = "";
      }

      // T·ª± ƒë·ªông focus v√†o √¥ QR code
      const qEl = document.getElementById("qrcode");
      if (qEl) {
        qEl.focus();
        qEl.select();
      }

      // üîπ QUAN TR·ªåNG: ƒê·ªìng b·ªô ng·∫ßm (kh√¥ng hi·ªÉn th·ªã alert)
      syncToSheet(false);
    }
    
    /* ===== Render b·∫£ng ===== */
    function renderTable() {
      const tbody = document.getElementById("logTable").getElementsByTagName("tbody")[0];
      tbody.innerHTML = "";

      const search = document.getElementById("searchBox").value.toLowerCase();
      const filterRes = document.getElementById("filterResult").value;

      // üîπ Duy·ªát ng∆∞·ª£c ƒë·ªÉ b·∫£n ghi m·ªõi nh·∫•t hi·ªÉn th·ªã tr√™n ƒë·∫ßu
      for (let i = records.length - 1; i >= 1; i--) {
        const rowData = records[i];
        
        if (search && !rowData[0].toLowerCase().includes(search) && !rowData[1].toLowerCase().includes(search)) continue;
        if (filterRes && rowData[2] !== filterRes) continue;

        const tr = tbody.insertRow();
        
        // üîπ THAY ƒê·ªîI: X√°c ƒë·ªãnh m√†u n·ªÅn theo k·∫øt qu·∫£
        let bgColor = "white";
        if (rowData[2] === "NG") {
          bgColor = "red";   // ƒë·ªè t∆∞∆°i cho NG
        } else if (rowData[2] === "OK") {
          // Ki·ªÉm tra n·∫øu ƒë√¢y l√† b·∫£n ghi OK sau khi ƒë√£ c√≥ NG
          const hasPreviousNG = checkIfHasPreviousNG(rowData[1], i);
          if (hasPreviousNG) {
            bgColor = "#27ae60"; // Xanh nh·∫°t cho OK sau NG
          } else {
            bgColor = "white"; // Tr·∫Øng cho OK th√¥ng th∆∞·ªùng
          }
        }
        tr.style.backgroundColor = bgColor;
        tr.style.color = (rowData[2] === "NG") ? "white" : "black";

        // üîπ THAY ƒê·ªîI: T·∫°o n√∫t x√≥a cho t·∫•t c·∫£ b·∫£n ghi
        for (let j = 0; j < rowData.length - 1; j++) {
          const td = tr.insertCell();
          td.textContent = rowData[j];
        }
        
        const actionCell = tr.insertCell();
        const deleteBtn = document.createElement("button");
        deleteBtn.textContent = "X√≥a";
        deleteBtn.onclick = function() { deleteRecord(i); };
        deleteBtn.style.padding = "4px 8px";
        deleteBtn.style.fontSize = "12px";
        actionCell.appendChild(deleteBtn);
      }
    }

    // üîπ H√†m ki·ªÉm tra xem QR code c√≥ b·∫£n ghi NG tr∆∞·ªõc ƒë√≥ kh√¥ng
    function checkIfHasPreviousNG(qrcode, currentIndex) {
      for (let i = currentIndex - 1; i >= 1; i--) {
        if (records[i][1] === qrcode) {
          if (records[i][2] === "NG") return true;
        }
      }
      return false;
    }

    /* ===== Delete record ===== */
    function deleteRecord(index) {
      if (!confirm("B·∫°n c√≥ ch·∫Øc mu·ªën x√≥a b·∫£n ghi n√†y?")) return;
      
      const deletedRow = records[index];
      const qrcode = deletedRow[1];
      const result = deletedRow[2];
      
      // Gi·∫£m counter
      if (qrCounter[qrcode] > 0) qrCounter[qrcode]--;
      if (qrCounter[qrcode] === 0) delete qrCounter[qrcode];
      
      // Gi·∫£m counts
      if (result === "OK") okCount--;
      else if (result === "NG") ngCount--;
      
      // X√≥a b·∫£n ghi
      records.splice(index, 1);
      
      saveLocal();
      renderTable();
      document.getElementById("okCount").textContent = okCount;
      document.getElementById("ngCount").textContent = ngCount;
      updateChart();
    }

    /* ===== Save to localStorage ===== */
    function saveLocal() {
      localStorage.setItem("records", JSON.stringify(records));
      localStorage.setItem("qrCounter", JSON.stringify(qrCounter));
    }

    /* ===== Clear log ===== */
    function clearLogDisplay() {
      if (confirm("B·∫°n c√≥ ch·∫Øc mu·ªën x√≥a to√†n b·ªô log hi·ªÉn th·ªã?")) {
        records = [["M√£ h√†ng","QR Code","K·∫øt qu·∫£","L·ªói","Gi·ªù","Ng√†y","S·ªë l·∫ßn xu·∫•t hi·ªán","Ng∆∞·ªùi ki·ªÉm tra","Ca","WO","Ghi ch√∫","S·ªë l∆∞·ª£ng giao","S·ªë l∆∞·ª£ng NG","Synced"]];
        qrCounter = {};
        okCount = 0;
        ngCount = 0;
        saveLocal();
        renderTable();
        document.getElementById("okCount").textContent = okCount;
        document.getElementById("ngCount").textContent = ngCount;
        updateChart();
      }
    }

    /* ===== Reset all data ===== */
    function resetAllData() {
      if (confirm("‚ö†Ô∏è B·∫°n c√≥ ch·∫Øc mu·ªën x√≥a TO√ÄN B·ªò d·ªØ li·ªáu? H√†nh ƒë·ªông n√†y kh√¥ng th·ªÉ ho√†n t√°c!")) {
        localStorage.clear();
        location.reload();
      }
    }

    /* ===== Export CSV ===== */
    function exportCSV() {
      const csvContent = records.map(row => row.join(",")).join("\n");
      const blob = new Blob([csvContent], { type: "text/csv;charset=utf-8;" });
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href = url;
      a.download = `PQC_${currentUser}_${new Date().toLocaleDateString("vi-VN")}.csv`;
      a.click();
      URL.revokeObjectURL(url);
    }

    /* ===== Google Sheets sync ===== */
    function syncToSheet(showAlert = false) {
      const sheetUrl = "https://script.google.com/macros/s/AKfycby8r_h94UslWQr7twjEkSDGJD6FSqNEWpW9VrXTuNit0gb0RWOrrdv0irDcrlus3dk2fg/exec"; 
      const syncStatus = document.getElementById("syncStatus");
      
      const dataToSend = records
        .slice(1)
        .filter(r => r[13] === false);

      if (dataToSend.length === 0) {
        if (showAlert) {
          alert("‚ö†Ô∏è Kh√¥ng c√≥ d·ªØ li·ªáu m·ªõi ƒë·ªÉ ƒë·ªìng b·ªô!");
        }
        return;
      }

      // Hi·ªÉn th·ªã tr·∫°ng th√°i ƒë·ªìng b·ªô
      syncStatus.textContent = `üîÑ ƒêang ƒë·ªìng b·ªô ${dataToSend.length} b·∫£n ghi...`;
      syncStatus.className = "sync-status sync-success";
      syncStatus.style.display = "block";

      fetch(sheetUrl, {
        method: "POST",
        body: JSON.stringify(dataToSend),
        headers: { "Content-Type": "application/json" },
        mode: "no-cors"
      })
      .then(() => {
        // Hi·ªÉn th·ªã th√¥ng b√°o t·∫°m th·ªùi
        syncStatus.textContent = `‚úÖ ƒê√£ ƒë·ªìng b·ªô ${dataToSend.length} b·∫£n ghi`;
        
        // ·∫®n th√¥ng b√°o sau 2 gi√¢y
        setTimeout(() => {
          syncStatus.style.display = "none";
        }, 2000);

        // ƒê√°nh d·∫•u c√°c d√≤ng ƒë√£ g·ª≠i
        for (let i = 1; i < records.length; i++) {
          const currentRecord = records[i];
          const isSent = dataToSend.some(sentRecord => 
            sentRecord[0] === currentRecord[0] && 
            sentRecord[1] === currentRecord[1] && 
            sentRecord[4] === currentRecord[4]
          );
          
          if (isSent) {
            records[i][13] = true;
          }
        }

        saveLocal();
      })
      .catch(err => {
        syncStatus.textContent = "‚ùå L·ªói ƒë·ªìng b·ªô";
        syncStatus.className = "sync-status sync-error";
        
        if (showAlert) {
          alert("‚ùå L·ªói ƒë·ªìng b·ªô: " + err);
        }
        console.error("L·ªói g·ª≠i d·ªØ li·ªáu:", err);
      });
    }
    
    /* ===== End shift report ===== */
    function endShiftReport() {
      const shift = currentShift;
      let totalOK = 0, totalNG = 0;
      
      // T√≠nh t·ªïng OK/NG cho ca hi·ªán t·∫°i (ch·ªâ l·∫•y k·∫øt qu·∫£ m·ªõi nh·∫•t c·ªßa m·ªói QR code)
      const latestResults = {};
      
      for (let i = 1; i < records.length; i++) {
        const row = records[i];
        if (row[8] === shift) {
          const qrcode = row[1];
          if (!latestResults[qrcode] || i > latestResults[qrcode].index) {
            latestResults[qrcode] = {
              result: row[2],
              index: i
            };
          }
        }
      }
      
      for (const qrcode in latestResults) {
        if (latestResults[qrcode].result === "OK") totalOK++;
        else if (latestResults[qrcode].result === "NG") totalNG++;
      }
      
      alert(`üìä B√ÅO C√ÅO CU·ªêI CA ${shift}\n\n‚úÖ OK: ${totalOK}\n‚ùå NG: ${totalNG}\nüì¶ T·ªïng s·∫£n ph·∫©m: ${totalOK + totalNG}`);
    }

    /* ===== Bi·ªÉu ƒë·ªì real-time ===== */
    function updateChart() {
      if (!chart) {
        const ctx = document.getElementById("chartOKNG").getContext("2d");
        chart = new Chart(ctx, {
          type: "doughnut",
          data: {
            labels: ["OK", "NG"],
            datasets: [{
              data: [okCount, ngCount],
              backgroundColor: ["#27ae60", "#e74c3c"],
              borderWidth: 1
            }]
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
              legend: { position: "bottom" }
            }
          }
        });
      } else {
        chart.data.datasets[0].data = [okCount, ngCount];
        chart.update();
      }
    }

    // ===== PH·∫¶N D·ªÆ LI·ªÜU =====
    let allData = [];
    let filteredDataGlobal = [];
    let clusterize;
    const API_URL = "https://script.google.com/macros/s/AKfycby8r_h94UslWQr7twjEkSDGJD6FSqNEWpW9VrXTuNit0gb0RWOrrdv0irDcrlus3dk2fg/exec?action=read";

    // H√†m chuy·ªÉn ƒë·ªïi timestamp Excel/Google Sheets sang ƒë·ªãnh d·∫°ng ng√†y gi·ªù Vi·ªát Nam
    function convertExcelTimestamp(timestamp, isDate = false) {
      if (!timestamp) return '';
      
      try {
          // N·∫øu ƒë√£ l√† ƒë·ªãnh d·∫°ng ƒë√∫ng (nh∆∞ "12:35:06" ho·∫∑c "6/11/2025") th√¨ gi·ªØ nguy√™n
          if (typeof timestamp === 'string') {
              // Ki·ªÉm tra n·∫øu ƒë√£ l√† ƒë·ªãnh d·∫°ng gi·ªù hh:mm:ss
              if (timestamp.match(/^\d{1,2}:\d{2}:\d{2}$/)) {
                  return timestamp;
              }
              // Ki·ªÉm tra n·∫øu ƒë√£ l√† ƒë·ªãnh d·∫°ng ng√†y dd/mm/yyyy ho·∫∑c d/m/yyyy
              else if (timestamp.match(/^\d{1,2}\/\d{1,2}\/\d{4}$/)) {
                  return timestamp;
              }
          }
          
          // X·ª≠ l√Ω timestamp d·∫°ng "1899-12-30T05:53:02.000Z" ho·∫∑c ISO
          if (typeof timestamp === 'string' && timestamp.includes('T')) {
              const dateObj = new Date(timestamp);
              if (!isNaN(dateObj)) {
                  if (isDate) {
                      // ƒê·ªãnh d·∫°ng ng√†y: dd/mm/yyyy
                      return dateObj.getDate().toString().padStart(2, '0') + '/' + 
                             (dateObj.getMonth() + 1).toString().padStart(2, '0') + '/' + 
                             dateObj.getFullYear();
                  } else {
                      // ƒê·ªãnh d·∫°ng gi·ªù: hh:mm:ss (gi·ªù ƒë·ªãa ph∆∞∆°ng)
                      return dateObj.getHours().toString().padStart(2, '0') + ':' + 
                             dateObj.getMinutes().toString().padStart(2, '0') + ':' + 
                             dateObj.getSeconds().toString().padStart(2, '0');
                  }
              }
          }
          
          // X·ª≠ l√Ω timestamp s·ªë (s·ªë ng√†y k·ªÉ t·ª´ 1899-12-30)
          if (typeof timestamp === 'number') {
              const excelEpoch = new Date(1899, 11, 30); // Th√°ng 11 = December
              const milliseconds = (timestamp - 1) * 24 * 60 * 60 * 1000; // -1 v√¨ Excel t√≠nh t·ª´ 1900-01-01
              const dateObj = new Date(excelEpoch.getTime() + milliseconds);
              
              if (!isNaN(dateObj)) {
                  if (isDate) {
                      return dateObj.getDate().toString().padStart(2, '0') + '/' + 
                             (dateObj.getMonth() + 1).toString().padStart(2, '0') + '/' + 
                             dateObj.getFullYear();
                  } else {
                      // L·∫•y ph·∫ßn th·∫≠p ph√¢n c·ªßa timestamp ƒë·ªÉ t√≠nh gi·ªù ph√∫t gi√¢y
                      const timeFraction = timestamp - Math.floor(timestamp);
                      const totalSeconds = Math.floor(timeFraction * 24 * 60 * 60);
                      const hours = Math.floor(totalSeconds / 3600);
                      const minutes = Math.floor((totalSeconds % 3600) / 60);
                      const seconds = totalSeconds % 60;
                      
                      return hours.toString().padStart(2, '0') + ':' + 
                             minutes.toString().padStart(2, '0') + ':' + 
                             seconds.toString().padStart(2, '0');
                  }
              }
          }
          
          // N·∫øu kh√¥ng x·ª≠ l√Ω ƒë∆∞·ª£c, tr·∫£ v·ªÅ nguy√™n b·∫£n
          return timestamp;
      } catch (e) {
          console.error('L·ªói chuy·ªÉn ƒë·ªïi timestamp:', e, timestamp);
          return timestamp;
      }
    }
    
    // Load d·ªØ li·ªáu t·ª´ Google Sheets
    function reloadFromGoogle() {
      const status = document.getElementById("recordCount");
      if (status) status.textContent = "üîÑ ƒêang t·∫£i d·ªØ li·ªáu...";

      fetch("https://script.google.com/macros/s/AKfycby8r_h94UslWQr7twjEkSDGJD6FSqNEWpW9VrXTuNit0gb0RWOrrdv0irDcrlus3dk2fg/exec?action=read")
          .then(res => res.text())
          .then(text => {
              let data;
              try {
                  data = JSON.parse(text);
              } catch (e) {
                  console.error("‚ùå Kh√¥ng parse ƒë∆∞·ª£c JSON:", e, text);
                  status.textContent = "‚ùå L·ªói d·ªØ li·ªáu tr·∫£ v·ªÅ (kh√¥ng ph·∫£i JSON)";
                  return;
              }

              // üîπ Tr∆∞·ªùng h·ª£p Apps Script tr·∫£ v·ªÅ object c√≥ "data"
              const rows = Array.isArray(data) ? data : data.data;
              if (!rows || rows.length === 0) {
                  status.textContent = "‚ö†Ô∏è Kh√¥ng c√≥ d·ªØ li·ªáu t·∫£i v·ªÅ";
                  return;
              }

              console.log("‚úÖ D·ªØ li·ªáu t·∫£i v·ªÅ:", rows.length, "b·∫£n ghi");

              allData = rows.map(r => {
                  return [
                      r.maHang || "",
                      r.qrCode || "",
                      r.phanDinh || "",
                      r.moTaLoi || "",
                      convertExcelTimestamp(r.gio), // üîπ S·ª¨A: Chuy·ªÉn ƒë·ªïi gi·ªù
                      convertExcelTimestamp(r.ngay, true), // üîπ S·ª¨A: Chuy·ªÉn ƒë·ªïi ng√†y
                      r.soLan || "",
                      r.maNV || "",
                      r.caLam || "",
                      r.po || "",
                      r.ghichu || "",
                      r.soLuongGiao || "",
                      r.soLuongNG || ""
                  ];
              });

              filteredDataGlobal = allData;
              updateMaSPDropdown();
              updateWODropdown();
              displayFilteredData();

              status.textContent = `‚úÖ ƒê√£ t·∫£i ${allData.length} b·∫£n ghi`;
          })
          .catch(err => {
              console.error("‚ùå L·ªói t·∫£i d·ªØ li·ªáu:", err);
              if (status) status.textContent = "‚ùå " + err.message;
          });
    }

    // √Åp d·ª•ng b·ªô l·ªçc
    function applyFilters() {
      const fromDate = document.getElementById("fromDate").value;
      const toDate = document.getElementById("toDate").value;
      const maSP = document.getElementById("maSP").value;
      const searchQR = document.getElementById("searchQR").value.toLowerCase();
      const po = document.getElementById("po").value;
      
      // L·ªçc d·ªØ li·ªáu
      filteredDataGlobal = allData.filter(row => {
          const rowDate = row[5]; // Ng√†y ·ªü c·ªôt 5 (ƒë√£ ƒë∆∞·ª£c chuy·ªÉn ƒë·ªïi)
          const rowMaSP = row[0]; // M√£ h√†ng ·ªü c·ªôt 0
          const rowQR = row[1]; // QR Code ·ªü c·ªôt 1
          const rowWO = row[9]; // WO ·ªü c·ªôt 9
          
          // Chuy·ªÉn ƒë·ªïi ng√†y t·ª´ dd/mm/yyyy sang yyyy-mm-dd ƒë·ªÉ so s√°nh
          let rowDateISO = '';
          if (rowDate && rowDate.includes('/')) {
              const parts = rowDate.split('/');
              let day, month, year;
              
              if (parts.length === 3) {
                  day = parts[0];
                  month = parts[1];
                  year = parts[2];
                  rowDateISO = `${year}-${month.padStart(2, '0')}-${day.padStart(2, '0')}`;
              }
          }
          
          // L·ªçc theo ng√†y
          if (fromDate && rowDateISO && rowDateISO < fromDate) return false;
          if (toDate && rowDateISO && rowDateISO > toDate) return false;
          
          // L·ªçc theo m√£ s·∫£n ph·∫©m
          if (maSP && rowMaSP !== maSP) return false;
          
          // L·ªçc theo QR code
          if (searchQR && !rowQR.toLowerCase().includes(searchQR)) return false;
          
          // L·ªçc theo WO
          if (po && rowWO !== po) return false;
          
          return true;
      });
      
      // C·∫≠p nh·∫≠t dropdown m√£ s·∫£n ph·∫©m
      updateMaSPDropdown();
      
      // C·∫≠p nh·∫≠t dropdown WO
      updateWODropdown();
      
      // Hi·ªÉn th·ªã d·ªØ li·ªáu ƒë√£ l·ªçc
      displayFilteredData();
    }
    
    // C·∫≠p nh·∫≠t dropdown m√£ s·∫£n ph·∫©m
    function updateMaSPDropdown() {
      const maSPSelect = document.getElementById("maSP");
      const currentValue = maSPSelect.value;
      
      // L·∫•y t·∫•t c·∫£ m√£ s·∫£n ph·∫©m duy nh·∫•t
      const uniqueMaSP = [...new Set(allData.map(row => row[0]))].filter(Boolean);
      
      maSPSelect.innerHTML = '<option value="">T·∫•t c·∫£ m√£</option>';
      uniqueMaSP.forEach(ma => {
        const option = document.createElement("option");
        option.value = ma;
        option.textContent = ma;
        maSPSelect.appendChild(option);
      });
      
      // Kh√¥i ph·ª•c gi√° tr·ªã ƒë√£ ch·ªçn
      if (currentValue) {
        maSPSelect.value = currentValue;
      }
    }

    // C·∫≠p nh·∫≠t dropdown WO
    function updateWODropdown() {
      const poSelect = document.getElementById("po");
      const currentValue = poSelect.value;
      
      // L·∫•y t·∫•t c·∫£ WO duy nh·∫•t
      const uniqueWO = [...new Set(allData.map(row => row[9]))].filter(Boolean);
      
      poSelect.innerHTML = '<option value="">T·∫•t c·∫£ WO</option>';
      uniqueWO.forEach(wo => {
        const option = document.createElement("option");
        option.value = wo;
        option.textContent = wo;
        poSelect.appendChild(option);
      });
      
      // Kh√¥i ph·ª•c gi√° tr·ªã ƒë√£ ch·ªçn
      if (currentValue) {
        poSelect.value = currentValue;
      }
    }

    // Hi·ªÉn th·ªã d·ªØ li·ªáu ƒë√£ l·ªçc
    function displayFilteredData() {
      const tbody = document.getElementById("clusterize-content");
      const status = document.getElementById("recordCount");
      
      if (!clusterize) {
        clusterize = new Clusterize({
          rows: [],
          scrollId: 'clusterize-scroll',
          contentId: 'clusterize-content'
        });
      }
      
      // T·∫°o HTML cho c√°c h√†ng
      const rowsHtml = filteredDataGlobal.map(row => {
        return `
          <tr>
            <td>${row[0] || ''}</td>
            <td>${row[1] || ''}</td>
            <td>${row[2] || ''}</td>
            <td>${row[3] || ''}</td>
            <td>${row[4] || ''}</td>
            <td>${row[5] || ''}</td>
            <td>${row[6] || ''}</td>
            <td>${row[7] || ''}</td>
            <td>${row[8] || ''}</td>
            <td>${row[9] || ''}</td>
            <td>${row[10] || ''}</td>
            <td>${row[11] || ''}</td>
            <td>${row[12] || ''}</td>
          </tr>
        `;
      });
      
      clusterize.update(rowsHtml);
      status.textContent = `üìä Hi·ªÉn th·ªã ${filteredDataGlobal.length} b·∫£n ghi`;
    }

    // ===== PH·∫¶N BI·ªÇU ƒê·ªí =====
    // V·∫Ω bi·ªÉu ƒë·ªì Pareto
    function drawPareto(data) {
      const ctx = document.getElementById('paretoChart').getContext('2d');
      
      // Th·ªëng k√™ l·ªói
      const errorStats = {};
      data.forEach(row => {
        const error = row[3] || 'Kh√¥ng c√≥ l·ªói';
        if (error) {
          errorStats[error] = (errorStats[error] || 0) + 1;
        }
      });
      
      // S·∫Øp x·∫øp theo s·ªë l∆∞·ª£ng gi·∫£m d·∫ßn
      const sortedErrors = Object.entries(errorStats)
        .sort((a, b) => b[1] - a[1])
        .slice(0, 10); // L·∫•y top 10 l·ªói
      
      const labels = sortedErrors.map(item => item[0]);
      const values = sortedErrors.map(item => item[1]);
      
      // T√≠nh t·ª∑ l·ªá ph·∫ßn trƒÉm t√≠ch l≈©y
      const total = values.reduce((sum, val) => sum + val, 0);
      let cumulative = 0;
      const percentages = values.map(val => {
        cumulative += val;
        return (cumulative / total) * 100;
      });
      
      // X√≥a bi·ªÉu ƒë·ªì c≈© n·∫øu c√≥
      if (window.paretoChartInstance) {
        window.paretoChartInstance.destroy();
      }
      
      // V·∫Ω bi·ªÉu ƒë·ªì Pareto
      window.paretoChartInstance = new Chart(ctx, {
        type: 'bar',
        data: {
          labels: labels,
          datasets: [
            {
              label: 'S·ªë l∆∞·ª£ng l·ªói',
              data: values,
              backgroundColor: 'rgba(54, 162, 235, 0.8)',
              order: 2
            },
            {
              label: 'T·ª∑ l·ªá t√≠ch l≈©y (%)',
              data: percentages,
              type: 'line',
              borderColor: 'rgba(255, 99, 132, 1)',
              backgroundColor: 'rgba(255, 99, 132, 0.2)',
              yAxisID: 'y1',
              order: 1
            }
          ]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          scales: {
            y: {
              beginAtZero: true,
              title: {
                display: true,
                text: 'S·ªë l∆∞·ª£ng l·ªói'
              }
            },
            y1: {
              beginAtZero: true,
              position: 'right',
              max: 100,
              title: {
                display: true,
                text: 'T·ª∑ l·ªá t√≠ch l≈©y (%)'
              },
              grid: {
                drawOnChartArea: false
              }
            }
          },
          plugins: {
            legend: {
              position: 'top'
            },
            tooltip: {
              callbacks: {
                label: function(context) {
                  if (context.datasetIndex === 0) {
                    return `S·ªë l∆∞·ª£ng: ${context.raw}`;
                  } else {
                    return `T·ª∑ l·ªá t√≠ch l≈©y: ${context.raw.toFixed(1)}%`;
                  }
                }
              }
            }
          }
        }
      });
    }

    // V·∫Ω bi·ªÉu ƒë·ªì theo ng√†y
    function drawDailyChart(data) {
      const ctx = document.getElementById('dailyChart').getContext('2d');
      
      // Th·ªëng k√™ theo ng√†y
      const dailyStats = {};
      data.forEach(row => {
        const date = row[5]; // Ng√†y ·ªü c·ªôt 5
        const result = row[2]; // K·∫øt qu·∫£ ·ªü c·ªôt 2
        
        if (!date) return;
        
        if (!dailyStats[date]) {
          dailyStats[date] = { OK: 0, NG: 0 };
        }
        
        if (result === 'OK') dailyStats[date].OK++;
        else if (result === 'NG') dailyStats[date].NG++;
      });
      
      // S·∫Øp x·∫øp theo ng√†y
      const sortedDates = Object.keys(dailyStats).sort();
      
      const okData = sortedDates.map(date => dailyStats[date].OK);
      const ngData = sortedDates.map(date => dailyStats[date].NG);
      
      // X√≥a bi·ªÉu ƒë·ªì c≈© n·∫øu c√≥
      if (window.dailyChartInstance) {
        window.dailyChartInstance.destroy();
      }
      
      // V·∫Ω bi·ªÉu ƒë·ªì c·ªôt
      window.dailyChartInstance = new Chart(ctx, {
        type: 'bar',
        data: {
          labels: sortedDates,
          datasets: [
            {
              label: 'OK',
              data: okData,
              backgroundColor: 'rgba(54, 162, 235, 0.8)'
            },
            {
              label: 'NG',
              data: ngData,
              backgroundColor: 'rgba(255, 99, 132, 0.8)'
            }
          ]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          scales: {
            x: {
              title: {
                display: true,
                text: 'Ng√†y'
              }
            },
            y: {
              beginAtZero: true,
              title: {
                display: true,
                text: 'S·ªë l∆∞·ª£ng'
              }
            }
          },
          plugins: {
            legend: {
              position: 'top'
            }
          }
        }
      });
    }

    // ===== KH·ªûI T·∫†O =====
    document.addEventListener("DOMContentLoaded", function() {
      // Kh·ªüi t·∫°o bi·ªÉu ƒë·ªì real-time
      updateChart();
      
      // Kh·ªüi t·∫°o ng√†y cho b·ªô l·ªçc
      const today = new Date().toISOString().split('T')[0];
      document.getElementById("fromDate").value = today;
      document.getElementById("toDate").value = today;
      
      // T·∫£i d·ªØ li·ªáu t·ª´ Google Sheets khi v√†o tab 2
      document.getElementById("btnTab2").addEventListener("click", function() {
        if (allData.length === 0) {
          reloadFromGoogle();
        }
      });

      // üîπ TH√äM: X·ª≠ l√Ω s·ª± ki·ªán cho √¥ s·ªë l∆∞·ª£ng giao
      document.getElementById("deliveryQty").addEventListener("change", function() {
        const newTarget = parseInt(this.value) || 0;
        if (newTarget < 0) {
          alert("‚ö†Ô∏è S·ªë l∆∞·ª£ng giao kh√¥ng th·ªÉ √¢m!");
          this.value = 0;
          return;
        }
        
        deliveryTarget = newTarget;
        deliveryCounter = 0;
        document.getElementById("deliveryStatus").textContent = "";
        
        // üîπ Reset c·∫£ s·ªë l∆∞·ª£ng NG khi thay ƒë·ªïi s·ªë l∆∞·ª£ng giao
        ngTarget = 0;
        ngCounter = 0;
        document.getElementById("ngQty").value = 0;
        document.getElementById("ngStatus").textContent = "";
      });

      // üîπ TH√äM: X·ª≠ l√Ω s·ª± ki·ªán cho √¥ s·ªë l∆∞·ª£ng NG
      document.getElementById("ngQty").addEventListener("change", function() {
        const newNgTarget = parseInt(this.value) || 0;
        if (newNgTarget < 0) {
          alert("‚ö†Ô∏è S·ªë l∆∞·ª£ng NG kh√¥ng th·ªÉ √¢m!");
          this.value = 0;
          return;
        }
        
        if (newNgTarget > deliveryTarget) {
          alert("‚ö†Ô∏è S·ªë l∆∞·ª£ng NG kh√¥ng th·ªÉ l·ªõn h∆°n s·ªë l∆∞·ª£ng giao!");
          this.value = 0;
          return;
        }
        
        ngTarget = newNgTarget;
        ngCounter = 0;
        document.getElementById("ngStatus").textContent = "";
      });
      
      // Kh·ªüi t·∫°o th√¥ng tin QR code
      updateQRCodeInfo();
    });
  </script>
</body>
</html>